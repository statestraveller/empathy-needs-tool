<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Empathy, Needs, & Strategies Assistant (ENSA) </title>
     <meta property="og:description" content="Transform parenting challenges into strategies that meet both of your needs.">
    <style>
        :root {
            --primary-color: #2C5282;
            --accent-color: #4299E1;
            --background-color: #F7FAFC;
            --text-color: #2D3748;
            --border-color: #E2E8F0;
            --step-inactive: #e3f4f9;
            --step-active: #1a8aa3;
            --step-text: #1a8aa3;
            --step-text-active: white;

        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .header {
            display: flex;
            flex-direction: row; /* Change to row for desktop */
            align-items: center;
            margin-bottom: 2rem;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .header img {
            width: 80px; /* Fixed size */
            height: 80px; /* Fixed size */
            border-radius: 50%;
            margin-bottom: 1rem;
            object-fit: cover; /* Maintain aspect ratio */
        }
        
        .header-text {
            margin-left: 20px; /* Add spacing between logo and text */
            text-align: left; /* Align text to the left */
        }

        .header-title {
            margin: 0;
            font-size: 1.8rem;
            color: var(--primary-color);
        }

        .header-subtitle {
            margin: 0.5rem 0 0;
            font-size: 1.2rem;
            font-weight: normal;
            color: var(--text-color);
        }

        button {
            padding: 12px 24px;
            margin: 5px;
            cursor: pointer;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.1s;
        }

        button:hover {
            background-color: var(--accent-color);
        }

        button:disabled {
            background-color: #CBD5E0;
            cursor: not-allowed;
        }

        .hidden {
            display: none;
        }

        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 1rem;
            font-size: 16px;
            font-family: 'Georgia', serif; /* Change to a more readable serif font */
            line-height: 1.6;
            color: var(--text-color);
            background-color: white;
            resize: vertical;
        }

        .output-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin: 1rem 0;
        }

        .checkbox-group {
            position: relative;
            margin: 2rem 0 1rem;
            padding: 2.5rem 1rem 1rem; /* Increased top padding */
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: white;
        }

        .checkbox-group legend {
            position: absolute;
            top: 0.5rem; /* Moved down from -1rem */
            left: 0.2rem;
            padding: 0.5rem;
            font-weight: 600;
            color: var(--primary-color);
            font-size: 1.4rem;
            line-height: 1.2;
        }

        .checkbox-item {
            display: flex;
            align-items: flex-start;
            margin: 8px 0;
            padding: 8px;
            background: var(--background-color);
            border-radius: 4px;
            transition: background-color 0.2s, color 0.2s;
            color: var(--text-color);
        }

        .checkbox-item:hover {
            background: var(--accent-color);
            color: white;
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: 12px;
            margin-top: 4px;
            width: 18px;
            height: 18px;
            accent-color: var(--primary-color);
        }

        .checkbox-item label {
            flex: 1;
            cursor: pointer;
        }

        .feelings-group, .needs-group {
            margin: 15px 0;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: white;
        }

        strong {
            color: var(--primary-color);
        }
        .step-container {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 120px;
            margin: 0 30px;
            z-index: 2; /* Ensure container is above the line */
        }
        
        .step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--step-inactive);
            color: var(--step-text);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            position: relative;
            margin-bottom: 8px;
            border: 3px solid var(--background-color); /* Add border to create gap effect */
            box-sizing: border-box;
        }
        
        .step-text {
            text-align: center;
            font-size: 0.8rem;
            line-height: 1.2;
            color: var(--step-text);
            max-width: 120px;
            margin-top: 4px;
        }
        
        .step-indicator, .step-indicator-clone {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            margin: 30px 0;
            position: relative;
            padding: 0 20px;
        }

        .step.active {
            background-color: var(--step-active);
            color: var(--step-text-active);
        }

        .step.completed {
            background-color: var(--step-active);
            color: var(--step-text-active);
        }

        .step-line {
            position: absolute;
            top: 20px; /* Center with the circles */
            left: 50px; /* Start from first step, not edge */
            right: 50px; /* End at last step, not edge */
            height: 3px;
            background-color: var(--step-inactive);
            transform: none; /* Remove translateY */
            z-index: 1;
        }

        .step-line-progress {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background-color: var(--step-active);
            transition: width 0.3s ease;
            width: 0%;
        }
        .example-text {
            color: #666;
            font-style: italic;
            margin: 10px 0 20px;
            line-height: 1.6;
            font-family: inherit;
        }
        .child-feelings-container {
            margin-top: 20px;
            padding: 10px;
            border-left: 4px solid var(--border-color);
            background-color: var(--background-color);
            white-space: pre-wrap;
        }
        .disclaimer {
            font-style: italic;
            color: #666;
            font-size: 0.9rem;
            margin-top: 0.5rem;
            margin-bottom: 0;
        }
        @media (prefers-color-scheme: dark) {
            textarea {
                background-color: #2D3748;
                color: var(--text-color);
                border-color: var(--border-color);
                font-family: 'Georgia', serif;
            }
            .checkbox-group {
                background: #2D3748;
            }
            .child-feelings-container {
                border-left-color: transparent;
                background-color: transparent;
            }

            .checkbox-item {
                background: #1A202C;
            }
            .disclaimer {
                color: #A0AEC0;
            }
            .checkbox-instruction {
                color: #A0AEC0;
            }
        }
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
            }
        
            .header img {
                width: 60px; /* Smaller on mobile */
                height: 60px;
                margin-bottom: 1rem;
            }
        
            .header-title {
                font-size: 1.4rem;
            }
            .disclaimer {
                font-size: 0.8rem;
            }
            .header-text {
                margin-left: 0;
                margin-top: 1rem;
                text-align: center;
            }
        
            .header-subtitle {
                font-size: 0.9rem;
            }
            .checkbox-group {
                padding-top: 2rem; /* Reduced padding at top */
                margin-top: 2rem; /* Reduced top margin */
                border-radius: 8px;
                position: relative;
            }

            .checkbox-group legend {
                position: relative; /* Change from absolute to relative */
                top: 14px; /* Reset top position */
                left: -12px;
                padding: 0.75rem 1rem 0.25rem;
                margin: 0 0 0.5rem;
                font-size: 1.3rem;
                font-weight: 600;
                color: var(--primary-color);
                background-color: transparent;
                width: 100%;
                display: block;
                border-bottom: 1px solid var(--border-color);
            }

            /* Adjust spacing for the instruction text */
            .checkbox-instruction {
                display: block;
                margin-top: 0;
                margin-bottom: 1.5rem;
                padding: 0 0.5rem;
                font-size: 0.9rem;
                line-height: 1.3;
            }

            /* Add better spacing between checkbox items */
            .checkbox-item {
                margin: 10px 0;
                padding: 10px;
            }

            /* Make sure the intro text is properly contained */
            .intro-text {
                margin: 0 0.5rem 1rem;
                line-height: 1.4;
                font-size: 0.95rem;
                clear: both;
            }
        
        
            .checkbox-item input[type="checkbox"] {
                margin-top: 0.25rem;
            }

            body {
                padding: 10px;
                font-size: 16px;
            }

            .header {
                flex-direction: column;
                text-align: center;
                padding: 0.5rem;
            }

            .header img {
                width: 50px;
                height: 50px;
                margin-right: 0;
                margin-bottom: 1rem;
            }

            h1 {
                font-size: 1.5rem;
            }

            h2 {
                font-size: 1.3rem;
            }
            h2.section-title {
                font-size: 1.8rem;
                color: var(--primary-color);
                margin: 1.5em 0 1em;
            }

            h3.section-subtitle {
                font-size: 1.4rem;
                color: var(--text-color);
                margin: 1em 0;
            }

            h3 {
                font-size: 1.1rem;
            }

            button {
                width: 100%;
                margin: 5px 0;
                padding: 15px;
                font-size: 16px;
            }

            textarea {
                font-size: 16px;
                padding: 10px;
            }

            .checkbox-group {
                padding: 10px;
            }

            .checkbox-item {
                padding: 10px;
            }

            .checkbox-item input[type="checkbox"] {
                width: 24px;
                height: 24px;
            }
            .step-container {
                width: 90px;
                margin: 0 15px;
            }
        
            .step-text {
                font-size: 0.7rem;
            }
        }

        /* Accessibility Improvements */
        button:focus-visible,
        textarea:focus-visible,
        input[type="checkbox"]:focus-visible {
            outline: 3px solid var(--accent-color);
            outline-offset: 2px;
        }

        /* High contrast mode support */
        @media (forced-colors: active) {
            button {
                border: 2px solid ButtonText;
            }
            
            .checkbox-item input[type="checkbox"] {
                border: 2px solid ButtonText;
            }
        }

        /* Reduced motion preference */
        @media (prefers-reduced-motion: reduce) {
            * {
                transition: none !important;
                scroll-behavior: auto !important;
            }
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            :root {
                --primary-color: #63B3ED;
                --accent-color: #4299E1;
                --background-color: #1A202C;
                --text-color: #E2E8F0;
                --border-color: #2D3748;
            }
            .checkbox-group legend {
                    color: #63B3ED;
                    border-bottom-color: var(--border-color);
                }
            body {
                background-color: var(--background-color);
                color: var(--text-color);
            }

            .header, .checkbox-group, .output-container {
                background: #2D3748;
                color: var(--text-color);
            }

            textarea {
                background: #2D3748;
                color: var(--text-color);
                border-color: var(--border-color);
            }

            .checkbox-item {
                background: #1A202C;
                color: var(--text-color);
            }

            .checkbox-item:hover {
                background: var(--accent-color);
                color: white;
            }

            button:disabled {
                background-color: #4A5568;
                color: #A0AEC0;
            }

            strong {
                color: #63B3ED;
            }

            .checkbox-group legend {
                color: #63B3ED;
            }
        }

        /* Fix for oversized buttons in strategies section on desktop */
        @media (min-width: 768px) {
            #strategiesFeedbackSection button {
                padding: 8px 16px;
                font-size: 16px;
                width: auto;
                max-width: 250px;
            }
            
            .button-group {
                display: flex;
                flex-direction: row;
                gap: 10px;
            }
        }

        /* Keep the buttons appropriately sized on mobile */
        @media (max-width: 767px) {
            #strategiesFeedbackSection button {
                width: 100%;
                margin: 8px 0;
                padding: 12px 15px;
            }
        }

        /* Button container for side-by-side buttons on desktop */
        .button-container {
            display: flex;
            flex-direction: row;
            gap: 10px;
        }
        
        /* Make buttons side by side on desktop */
        @media (min-width: 768px) {
            .button-container button {
                flex: 0 1 auto;
                padding: 8px 16px;
                font-size: 16px;
            }
        }
        
        /* Stack buttons vertically on mobile */
        @media (max-width: 767px) {
            .button-container {
                flex-direction: column;
            }
            
            .button-container button {
                width: 100%;
                margin: 5px 0;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <img src="Podcast_Cover.jpg" alt="Jen Lumanlan's Logo">
        <div class="header-text">
            <h1 class="header-title">Empathy, Needs & Strategies Assistant (ENSA)</h1>
            <h2 class="header-subtitle">Transforming challenges into shared understanding and actionable strategies.</h2>
            <p class="disclaimer">Note: This tool is currently under development. Feel free to check with Jen if you feel uncertain about the outputs.</p>
        </div>
    </div>

    <div class="step-indicator">
        <div class="step-line">
            <div class="step-line-progress"></div>
        </div>
        <div class="step-container">
            <div class="step active" id="step1">1</div>
            <div class="step-text">Your Feelings & Needs</div>
        </div>
        <div class="step-container">
            <div class="step" id="step2">2</div>
            <div class="step-text">Your Child's Feelings & Needs</div>
        </div>
        <div class="step-container">
            <div class="step" id="step3">3</div>
            <div class="step-text">Strategies that work for both of you</div>
        </div>
    </div>

    <h2>Step 1: Understand Your Feelings and Needs</h2>
    <h3>Describe in your own words what is going on with your child</h3>
    <p class="example-text">Example: "My 4-year-old throws himself on the floor screaming when it's time to leave the playground. This happens almost every time, even when I give him a 5-minute warning. The tantrum typically lasts about 10 minutes, with him refusing to get up or listen to anything I say. I've tried ignoring it, offering comfort, and using rewards for smooth transitions, but nothing seems to work consistently."</p>
    <textarea id="userInput" rows="4" placeholder="Type here..."></textarea><br><br>
    <button onclick="analyzeText()">Analyze</button>
    
    <div id="outputContainer" style="margin-top: 20px;">
        <div id="output" class="hidden"></div>
        
        <div id="feedbackSection" class="hidden" style="margin-top: 15px;">
            <p>Does this capture how you're feeling? If not, please describe the situation in a bit more detail in the box and I'll re-analyze.</p>
            <button onclick="processFeelings()">Yes, these feelings are accurate</button>
            <button onclick="analyzeText()">No, I added more information</button>
        </div>
        
        <div id="secondOutput" class="hidden"></div>
        
        <div id="needsFeedbackSection" class="hidden" style="margin-top: 15px;">
            <p>Do you think these needs are accurate for you? If so, great! If not, please add more detail in the text box.</p>
            <button onclick="moveToStep2()">Yes, proceed to Step 2</button>
            <button onclick="reAnalyzeNeeds()">Re-Analyze Needs</button>
        </div>
    </div>
    
    <div id="step2Container" class="hidden" style="margin-top: 40px; border-top: 1px solid #ccc; padding-top: 20px;">
        <div class="step-indicator-clone">
            <div class="step-line">
                <div class="step-line-progress"></div>
            </div>
            <div class="step-container">
                <div class="step completed" id="step1-clone-2">1</div>
                <div class="step-text">Your Feelings & Needs</div>
            </div>
            <div class="step-container">
                <div class="step" id="step2-clone-2">2</div>
                <div class="step-text">Your Child's Feelings & Needs</div>
            </div>
            <div class="step-container">
                <div class="step" id="step3-clone-2">3</div>
                <div class="step-text">Strategies that work for both of you</div>
            </div>
        </div>
        <h2>Step 2: Understand Your Child's Feelings and Needs</h2>
        <p>To help identify what your child might be feeling, please provide more information:</p>
        
        <div style="margin: 15px 0;">
            <label for="childAction"><strong>A. What did the child do during this incident?</strong></label><br>
            <textarea id="childAction" rows="3" placeholder="Describe their actions..."></textarea>
        </div>
        
        <div style="margin: 15px 0;">
            <label for="childWords"><strong>B. What did the child say during this incident?</strong></label><br>
            <textarea id="childWords" rows="3" placeholder="Their words, tone, etc..."></textarea>
        </div>
        
        <div style="margin: 15px 0;">
            <label for="recentChanges"><strong>C. Have any big changes happened in the child's life recently?</strong></label><br>
            <p style="font-size: 0.9em; margin: 5px 0;">New school/teacher? New sibling? Parental pregnancy? Sibling in a new developmental stage? Sibling or friend struggles?</p>
            <textarea id="recentChanges" rows="3" placeholder="Recent changes or transitions..."></textarea>
        </div>
        
        <div style="margin: 15px 0;">
            <label for="connectionTime"><strong>D. Are you getting 10 minutes of daily connection time with your child right now?</strong></label><br>
            <textarea id="connectionTime" rows="2" placeholder="Describe your connection time..."></textarea>
        </div>
        
        <div style="margin: 15px 0;">
            <label for="neurodivergence"><strong>E. Is there any diagnosed or suspected neurodivergence?</strong></label><br>
            <textarea id="neurodivergence" rows="2" placeholder="ADHD, autism, sensory processing differences, etc..."></textarea>
        </div>
        
        <button onclick="analyzeChildFeelings()">Analyze Child's Feelings</button>
        
        <div id="childFeelingsOutput" class="hidden child-feelings-container"></div>
        
        <div id="childFeedbackSection" class="hidden" style="margin-top: 15px;">
            <p>Do you think this captures what your child might be feeling? If not, please add more information to any text box above.</p>
            <button onclick="childFeelingsConfirmed()">Yes, these feelings seem correct</button>
            <button onclick="analyzeChildFeelings()">No, I've added more information</button>
        </div>
        
        <div id="childNeedsOutput" class="hidden child-feelings-container"></div>
        
        <div id="childNeedsFeedbackSection" class="hidden" style="margin-top: 15px;">
            <p>Do you think these needs are accurate for your child? If so, great! If not, please add more detail in the text boxes.</p>
            <button onclick="moveToStep3()">Yes, proceed to Step 3</button>
            <button onclick="reAnalyzeChildNeeds()">Re-Analyze Needs</button>
        </div>
        
        <div id="step3Container" class="hidden" style="margin-top: 40px; border-top: 1px solid #ccc; padding-top: 20px;">
            <div class="step-indicator-clone">
                <div class="step-line">
                    <div class="step-line-progress"></div>
                </div>
                <div class="step-container">
                    <div class="step completed" id="step1-clone-3">1</div>
                    <div class="step-text">Your Feelings & Needs</div>
                </div>
                <div class="step-container">
                    <div class="step completed" id="step2-clone-3">2</div>
                    <div class="step-text">Your Child's Feelings & Needs</div>
                </div>
                <div class="step-container">
                    <div class="step" id="step3-clone-3">3</div>
                    <div class="step-text">Strategies that work for both of you</div>
                </div>
            </div>
            <h2>Step 3: Strategies to Meet Both Your Needs</h2>
            
            <div id="strategiesOutput" class="hidden child-feelings-container"></div>
            
            <div id="strategiesFeedbackSection" class="hidden" style="margin-top: 15px;">
                <p>You don't have to try all of these ideas! They're intended to give you a starting point for what might work for both of you.</p>
                <p>Do you see something here you could try? If not, please explain below and I'll give you some more ideas.</p>
                <p><strong>Uncheck any options you don't think will be helpful</strong>, and then I'll give you more detail on how to implement the ideas you'd like to try.</p>
                <textarea id="strategyFeedback" rows="4" placeholder="Let me know what won't work about these strategies and why..."></textarea>
                <p class="strategy-note" style="font-style: italic; color: #666; margin-top: 8px; font-size: 0.9em;">The ENSA tool can have a hard time thinking creatively about strategies. If the needs seem right but the strategies aren't good, share your needs with us in the community and we'll help you find strategies!</p>
                <div class="button-container" style="margin-top:15px;">
                    <button onclick="getImplementationDetails()">Get Implementation Details</button>
                    <button onclick="reAnalyzeStrategies()">Re-Analyze Strategies</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // button closing point of getting implementati
        // Global variables to store responses
        let firstPromptResponse = "";
        let childFeelingsResponse = "";

        // Button state management
        function disableButton(button) {
            button.disabled = true;
            button.style.cursor = 'not-allowed';
        }

        function enableButton(button) {
            button.disabled = false;
            button.style.cursor = 'pointer';
        }

        // API settings
        const API_SETTINGS = {
            feelings: {
                max_tokens: 500,
                temperature: 0.7
            },
            needs: {
                max_tokens: 800,
                temperature: 0.7
            },
            strategies: {
                max_tokens: 1500,
                temperature: 0.7
            }
        };

        const FEELINGS = {
            needsMet: {
                affectionate: ['friendly', 'openhearted', 'tender', 'warm', 'loving', 'compassionate'],
                engaged: ['alert', 'curious', 'absorbed'],
                hopeful: ['encouraged', 'optimistic'],
                confident: ['open', 'safe', 'proud', 'empowered'],
                excited: ['surprised', 'energetic', 'enthusiastic', 'invigorated', 'passionate', 'vibrant'],
                grateful: ['appreciative', 'thankful', 'touched'],
                inspired: ['wonder', 'awed'],
                joyful: ['happy', 'pleased', 'amused', 'glad', 'jubilant'],
                exhilarated: ['elated', 'enthralled', 'radiant', 'thrilled'],
                peaceful: ['calm', 'clearheaded', 'comfortable', 'centered', 'content', 'fulfilled', 'relaxed', 'relieved', 'satisfied'],
                refreshed: ['rested', 'renewed', 'enlivened']
            },
            needsNotMet: {
                confused: ['hesitant', 'ambivalent', 'bewildered', 'lost'],
                disconnected: ['distracted', 'bored', 'cold', 'indifferent', 'detached', 'numb', 'withdrawn', 'resentful'],
                uneasy: ['restless', 'startled', 'surprised', 'uncomfortable', 'agitated', 'troubled', 'alarmed', 'rattled', 'upset', 'shocked'],
                yearning: ['wistful', 'longing', 'envious', 'jealous'],
                embarrassed: ['self-conscious', 'flustered', 'ashamed', 'guilty'],
                fatigued: ['tired', 'sleepy', 'depleted', 'exhausted', 'burnt out'],
                pain: ['hurt', 'lonely', 'miserable', 'regretful', 'remorseful', 'grief', 'heartbroken', 'agony'],
                anger: ['peeved', 'disgruntled', 'irritated', 'aggravated', 'annoyed', 'incensed', 'outraged', 'furious'],
                tense: ['anxious', 'cranky', 'distressed', 'irritable', 'nervous', 'worried', 'wary', 'dread', 'afraid', 'panicked', 'defensive', 'overwhelmed', 'stressed out', 'terrified'],
                vulnerable: ['fragile', 'sensitive', 'exposed', 'guarded', 'reserved', 'insecure', 'helpless'],
                sad: ['unhappy', 'heavyhearted', 'disappointed', 'discouraged', 'hopeless', 'dejected', 'despair']
            }
        };

        const NEEDS = {
            connection: [
                'acceptance', 'appreciation', 'belonging', 'collaboration', 'communication',
                'empathy', 'kindness', 'love', 'partnership', 'support',
                'to understand and be understood', 'touch', 'trust'
            ],
            peace: [
                'beauty', 'calm', 'ease', 'harmony', 'order', 'respect'
            ],
            honesty: [
                'authenticity', 'integrity', 'presence'
            ],
            meaning: [
                'challenge', 'competence', 'creativity', 'growth', 'having a sense of purpose',
                'hope', 'learning', 'self-connection', 'self-expression'
            ],
            safety: [
                'consistency', 'physical and emotional safety'
            ],
            autonomy: [
                'choice', 'freedom', 'independence', 'power', 'space/freedom from touch'
            ],
            relaxation: [
                'excitement', 'fun', 'humor', 'indulgence', 'joy',
                'mental space', 'play', 'pleasure'
            ],
            physicalWellbeing: [
                'air', 'comfort', 'exercise', 'food/water', 'rest/sleep',
                'safety', 'safety of children/dependents', 'self-care', 'sexual expression'
            ]
        };

        function getCheckedItems(groupId) {
            const checkboxes = document.querySelectorAll(`#${groupId} input[type="checkbox"]`);
            const checkedMap = new Map();

            checkboxes.forEach(checkbox => {
                const label = checkbox.nextElementSibling.innerHTML;
                checkedMap.set(label, checkbox.checked);
            });

            return checkedMap;
        }
 
        function scrollToElement(elementId, offset = 50) {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    // Ensure the element is visible first
    if (element.classList.contains("hidden")) {
        element.classList.remove("hidden");
    }
    
    // Immediately prevent any default scroll behavior
    window.scrollTo(window.scrollX, window.scrollY);
    
    // Test if we're on mobile
    const isMobile = window.innerWidth <= 768;
    
    // Force a small delay to ensure the browser has fully rendered the element
    setTimeout(() => {
        try {
            // Get the current scroll position to prevent jumping
            const currentScroll = window.scrollY;
            
            // Look specifically for a heading or title element to target
            let targetElement = element;
            const heading = element.querySelector('h2, h3, h4, legend');
            
            if (heading) {
                targetElement = heading;
            } else if (element.firstElementChild) {
                targetElement = element.firstElementChild;
            }
            
            if (isMobile) {
                // Mobile-specific smooth scroll with position lock
                const targetPosition = targetElement.getBoundingClientRect().top + currentScroll;
                const mobileOffset = 100;
                
                // Lock scroll position during calculation
                window.scrollTo(window.scrollX, currentScroll);
                
                window.scrollTo({
                    top: Math.max(0, targetPosition - mobileOffset),
                    behavior: 'smooth'
                });
            } else {
                // Desktop smooth scroll
                const rect = targetElement.getBoundingClientRect();
                const elementTop = rect.top + window.scrollY;
                
                // Lock scroll position during calculation
                window.scrollTo(window.scrollX, currentScroll);
                
                window.scrollTo({
                    top: elementTop - offset,
                    behavior: 'smooth'
                });
            }
        } catch (e) {
            console.error("Scrolling error:", e);
            // Fallback that maintains position
            element.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }
    }, 150);
}
        // Function to show an element by ID
        function show(elementOrId) {
            const element = typeof elementOrId === 'string' ? 
                document.getElementById(elementOrId) : elementOrId;

            if (element && element.classList) {
                element.classList.remove("hidden");
            }
        }
        
        // Function to hide an element by ID
        function hide(id) {
            document.getElementById(id).classList.add("hidden");
        }

        // Function to create checkboxes for feelings/needs
        function createCheckboxGroup(items, groupId, groupTitle, previouslyChecked = null) {
            const container = document.createElement('fieldset');
            container.className = 'checkbox-group';
            container.id = groupId;
            container.setAttribute('aria-label', groupTitle);

            const legend = document.createElement('legend');
            legend.textContent = groupTitle;
            container.appendChild(legend);
        
            // Add instruction text
            const instruction = document.createElement('p');
            instruction.className = 'checkbox-instruction';
            instruction.style.fontSize = '0.9em';
            instruction.style.color = '#666';
            instruction.style.marginBottom = '1rem';
             // Different instruction text based on group type
             // add instruction text for child-feelings-group and child needs-group
             if (groupId === 'child-feelings-group') {
                instruction.textContent = "Please uncheck the boxes next to any feelings that you don't think are relevant for your child.";
            } else if (groupId === 'child-needs-group') {
                instruction.textContent = "Please uncheck the boxes next to any needs that you don't think are relevant for your child.";
            } else {
                instruction.textContent = `Please uncheck the boxes next to any ${groupTitle.toLowerCase()} that aren't relevant for you.`;
            }
            container.appendChild(instruction);

            // Add the intro line without checkbox
            const lines = items.split('\n');
            const introLine = lines.find(line => 
                line.toLowerCase().includes("i wonder if") || 
                line.toLowerCase().includes("i'm wondering if")
            );

            if (introLine) {
                const intro = document.createElement('p');
                intro.className = 'intro-text';
                intro.style.marginBottom = '1rem';
                intro.textContent = introLine.trim();
                container.appendChild(intro);
            }


            // Parse the bullet points, excluding the intro line
            const bulletPoints = items
                .split('•')
                .filter(item => item.trim())
                .map(item => {
                    let cleanItem = item.trim().replace(/^[-\s]+/, '').trim();
                    
                    // Skip if this is an intro line
                    if (cleanItem.toLowerCase().includes("i wonder if") || 
                        cleanItem.toLowerCase().includes("i'm wondering if") ||
                        cleanItem.toLowerCase().includes("here are some strategies")) {
                        return null;
                    }
                    
                    let [feeling, explanation] = cleanItem.split(/:(.*)/s).map(s => s ? s.trim() : '');
                    return { feeling, explanation };
                })
                .filter(item => item !== null);
            
                bulletPoints.forEach((item, index) => {
                    if (item.feeling) {
                        const div = document.createElement('div');
                        div.className = 'checkbox-item';
                    
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.id = `${groupId}-${index}`;
                        
                        // Check if this item was previously checked
                        const label = `<strong>${item.feeling}</strong>${item.explanation ? ': ' + item.explanation : ''}`;
                        checkbox.checked = previouslyChecked ? 
                            (previouslyChecked.has(label) ? previouslyChecked.get(label) : true) : 
                            true;
                    
                        const labelElement = document.createElement('label');
                        labelElement.htmlFor = checkbox.id;
                        labelElement.innerHTML = label;
                    
                        div.appendChild(checkbox);
                        div.appendChild(labelElement);
                        container.appendChild(div);
                    }
                });
        
            return container;
        }

        // Modify the display functions to include checkboxes
        function displayWithCheckboxes(response, containerId, groupId, title, previouslyChecked = null) {
            const container = document.getElementById(containerId);
            container.innerHTML = ''; // Clear existing content
            
            // Create and append checkbox group
            const checkboxGroup = createCheckboxGroup(response, groupId, title, previouslyChecked);
            container.appendChild(checkboxGroup);

            // Scroll to the new content
            scrollToElement(containerId);
        }

        // Function to get selected items from a checkbox group
        function getSelectedItems(groupId) {
            const checkboxes = document.querySelectorAll(`#${groupId} input[type="checkbox"]:checked`);
            return Array.from(checkboxes).map(cb => cb.nextElementSibling.textContent.trim());
        }

        // Function to analyze the text
        async function analyzeText() {
            const button = document.querySelector('button[onclick="analyzeText()"]');
            disableButton(button);
            const currentScroll = window.scrollY;
            window.scrollTo(window.scrollX, currentScroll);
            // Get user input
            const userInput = document.getElementById("userInput").value.trim();
            const outputDiv = document.getElementById("output");
            
            // Hide previous outputs and feedback
            hide("feedbackSection");
            hide("secondOutput");
            
            // Remove any existing missed feelings sections
            const existingMissedFeelingsSection = document.getElementById("parentMissedFeelingsSection");
            if (existingMissedFeelingsSection) {
                existingMissedFeelingsSection.remove();
            }
            
            // Show the output div
            show("output");
            
            // Validate input
            if (!userInput) {
                outputDiv.innerHTML = "Please enter some text about your child's behavior.";
                enableButton(button);
                return;
            }
            
            // Show loading message
            outputDiv.innerHTML = "Analyzing... Please wait.";
            
            // Prepare the prompt
            // Update the feelingsPrompt in the analyzeText and reAnalyzeNeeds functions
            // Update the feelings prompt to require at least 3 feelings
            const feelingsPrompt = `You are Jen Lumanlan. You are working with a parent who is having trouble with their child's behavior. 
            They have said this about their child: "${userInput}".
                    
            Please respond with a hypothesis about the parent's feelings. Your response MUST:
            1. Start with "I wonder if you're feeling:"
                    
            2. ALWAYS include AT LEAST 3 different feelings, formatted as bullet points with "•" and using HTML <strong> tags for the feeling name.
            Format exactly like this:
            • <strong>FRUSTRATED</strong>: Because your attempts to help aren't working
            • <strong>WORRIED</strong>: Because you care about your child's development
            
            3. For theft/stealing scenarios, consider feelings like SHOCKED, WORRIED, DISAPPOINTED, EMBARRASSED, ASHAMED.
            
            4. ONLY use feelings from this exact list (and capitalize them):
            ${Object.entries(FEELINGS.needsMet).map(([category, feelings]) => feelings.map(f => f.toUpperCase()).join(', ')).join(', ')}, 
            ${Object.entries(FEELINGS.needsNotMet).map(([category, feelings]) => feelings.map(f => f.toUpperCase()).join(', ')).join(', ')}
            
            Do not use words that aren't feelings (like "criticized" or "attacked"). Stick strictly to the feelings list provided.`;

            try {
                // Make the API request
                const response = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer ${process.env.OPENAI_API_KEY}",                         
                        },
                    body: JSON.stringify({
                        model: "gpt-3.5-turbo",
                        messages: [
                            {
                                role: "user",
                                content: feelingsPrompt
                            }
                        ],
                        ...API_SETTINGS.feelings
                    })
                });
                
                // Handle the response
                const data = await response.json();
                
                if (data.error) {
                    console.error("OpenAI API Error:", data.error);
                    outputDiv.innerHTML = "Error: " + data.error.message;
                    return;
                }
                
                // Store the first prompt response and display it
                firstPromptResponse = data.choices[0].message.content.trim();
                displayWithCheckboxes(firstPromptResponse, "output", "feelings-group", "Your Feelings");
                
                // Show the feedback section AND the missed feelings option
                show("feedbackSection");
                showParentMissedFeelingsOption(); // Add this line
                
                scrollToElement("feedbackSection");
                
            } catch (error) {
                console.error("Fetch Error:", error);
                outputDiv.innerHTML = "Error: Network issue or invalid API key. Please check your console for details.";
            } finally {
                enableButton(button);
            }
        }
        
        // Function to re-analyze needs based on additional information
        async function reAnalyzeNeeds() {
            const previouslyChecked = getCheckedItems("needs-group");
            const userInput = document.getElementById("userInput").value.trim();
            const secondOutputDiv = document.getElementById("secondOutput");
            const selectedFeelings = getSelectedItems("feelings-group").join(", ");
            
            // Remove any existing missed needs sections
            const existingMissedNeedsSection = document.getElementById("parentMissedNeedsSection");
            if (existingMissedNeedsSection) {
                existingMissedNeedsSection.remove();
            }
            
            // Show loading message
            secondOutputDiv.innerHTML = "Re-analyzing your needs... Please wait.";
            
            try {
                // First, re-analyze feelings based on updated input
                // Update the feelingsPrompt in the analyzeText and reAnalyzeNeeds functions
                const feelingsPrompt = `You are Jen Lumanlan. You are working with a parent who is having trouble with their child's behavior. 
            They have said this about their child: "${userInput}".
                    
            Please respond with a hypothesis about the parent's feelings. Your response MUST:
            1. Start with "I wonder if you're feeling:"
                    
            2. ALWAYS include AT LEAST 3 different feelings, formatted as bullet points with "•" and using HTML <strong> tags for the feeling name.
            Format exactly like this:
            • <strong>FRUSTRATED</strong>: Because your attempts to help aren't working
            • <strong>WORRIED</strong>: Because you care about your child's development
            
            3. For theft/stealing scenarios, consider feelings like SHOCKED, WORRIED, DISAPPOINTED, EMBARRASSED, ASHAMED.
            
            4. ONLY use feelings from this exact list (and capitalize them):
            ${Object.entries(FEELINGS.needsMet).map(([category, feelings]) => feelings.map(f => f.toUpperCase()).join(', ')).join(', ')}, 
            ${Object.entries(FEELINGS.needsNotMet).map(([category, feelings]) => feelings.map(f => f.toUpperCase()).join(', ')).join(', ')}
            
            Do not use words that aren't feelings (like "criticized" or "attacked"). Stick strictly to the feelings list provided.`;
                
                const feelingsResponse = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer ${process.env.OPENAI_API_KEY}",                         
                    },
                    body: JSON.stringify({
                        model: "gpt-3.5-turbo",
                        messages: [
                            {
                                role: "user",
                                content: feelingsPrompt
                            }
                        ],
                        ...API_SETTINGS.feelings
                    })
                });
                
                const feelingsData = await feelingsResponse.json();
                
                if (feelingsData.error) {
                    console.error("OpenAI API Error:", feelingsData.error);
                    secondOutputDiv.innerHTML = "Error: " + feelingsData.error.message;
                    return;
                }
                
                // Update firstPromptResponse with the new feelings analysis
                firstPromptResponse = feelingsData.choices[0].message.content.trim();
                
                // Now, analyze needs based on the updated feelings
                // Update the needsPrompt in the processFeelings and reAnalyzeNeeds functions
                const needsPrompt = `You are Jen Lumanlan. The parent has acknowledged these feelings: ${selectedFeelings}

                Please analyze their needs. Your response MUST:
                1. For EACH feeling or related group of feelings, identify the specific underlying needs
                2. ONLY use needs from this categorized list (and capitalize them):
                ${Object.entries(NEEDS).map(([category, needs]) => 
                    `${category.toUpperCase()}: ${needs.map(n => n.toUpperCase()).join(', ')}`
                ).join('\n')}

                3. Start with "I wonder if your needs might be:"

                4. Format each need as a bullet point with "•" and use HTML <strong> tags for the need name.
                Format exactly like this:
                • <strong>COMMUNICATION</strong>: It seems like you yearn for clearer exchanges with your child about what happens at bedtime
                • <strong>TRUST</strong>: Your shock at your child stealing may indicate a need for trust in your relationship with them
                
                IMPORTANT GUIDELINES:
                - Do NOT include advice, strategies, or instructions on what the parent should do
                - Focus ONLY on identifying what the parent's needs are, not how to meet them
                - Explain WHY they might have this need based on their feelings
                - Keep explanations personal and relevant to their situation
                - Identify the underlying need, not the solution or action to take
                - Focus on what the parent is feeling or experiencing, not what they "should" do
                
                FORBIDDEN PHRASES - NEVER USE:
                - "You may benefit from..."
                - "Try to..."
                - "Consider..."
                - "Establish..."
                - "Communicate..."
                - "can help create..."
                - "is essential for..."
                - Any instruction about what they should do
                - Any statement about what would help them
                
                Make each explanation personal and specific to the situation. Consider both immediate and underlying needs.`;

                
                const needsResponse = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer ${process.env.OPENAI_API_KEY}",                         
                    },
                    body: JSON.stringify({
                        model: "gpt-3.5-turbo",
                        messages: [
                            {
                                role: "user",
                                content: needsPrompt
                            }
                        ],
                        ...API_SETTINGS.needs
                    })
                });
                
                const needsData = await needsResponse.json();
                
                if (needsData.error) {
                    console.error("OpenAI API Error:", needsData.error);
                    secondOutputDiv.innerHTML = "Error: " + needsData.error.message;
                    return;
                }
                
                // Display the updated needs analysis
                const aiResponse = needsData.choices[0].message.content.trim();
                
                // Convert markdown bold to HTML before displaying
                const formattedResponse = aiResponse.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                displayWithCheckboxes(formattedResponse, "secondOutput", "needs-group", "Your Needs", previouslyChecked);
                
                // Make sure the needs feedback section is visible
                show("needsFeedbackSection");
                scrollToElement("needsFeedbackSection");
                
            } catch (error) {
                console.error("Fetch Error:", error);
                secondOutputDiv.innerHTML = "Error: Network issue or invalid API key. Please check your console for details.";
            }
        }
        


        // Function to process feelings and get needs
        async function processFeelings() {
            const button = document.querySelector('button[onclick="processFeelings()"]');
            disableButton(button);

            const currentScroll = window.scrollY;
            window.scrollTo(window.scrollX, currentScroll);


            const secondOutputDiv = document.getElementById("secondOutput");
            show("secondOutput");
            secondOutputDiv.innerHTML = "Analyzing your needs based on these feelings... Please wait.";
            
            // Display feelings with checkboxes first
            displayWithCheckboxes(firstPromptResponse, "output", "feelings-group", "Your Feelings");
            
            // Use selected feelings for the next prompt
            const selectedFeelings = getSelectedItems("feelings-group").join(", ");
            
            // Prepare the second prompt
            // Update the needsPrompt in the processFeelings and reAnalyzeNeeds functions
            const needsPrompt = `You are Jen Lumanlan. The parent has acknowledged these feelings: ${selectedFeelings}
                    
            Please analyze their needs. Your response MUST:
            1. For EACH feeling or related group of feelings, identify the specific underlying needs
            2. ONLY use needs from this categorized list (and capitalize them):
            ${Object.entries(NEEDS).map(([category, needs]) => 
                `${category.toUpperCase()}: ${needs.map(n => n.toUpperCase()).join(', ')}`
            ).join('\n')}
                    
            3. Start with "I wonder if your needs might be:"
                    
            4. Format each need as a bullet point with "•" and use HTML <strong> tags for the need name.
            Format exactly like this:
            • <strong>COMMUNICATION</strong>: It seems like you yearn for clearer exchanges with your child about what happens at bedtime
            • <strong>TRUST</strong>: Your shock at your child stealing may indicate a need for trust in your relationship with them
            
            IMPORTANT GUIDELINES:
            - Do NOT include advice, strategies, or instructions on what the parent should do
            - Focus ONLY on identifying what the parent's needs are, not how to meet them
            - Explain WHY they might have this need based on their feelings
            - Keep explanations personal and relevant to their situation
            - Identify the underlying need, not the solution or action to take
            - Focus on what the parent is feeling or experiencing, not what they "should" do
            
            FORBIDDEN PHRASES - NEVER USE:
            - "You may benefit from..."
            - "Try to..."
            - "Consider..."
            - "Establish..."
            - "Communicate..."
            - "can help create..."
            - "is essential for..."
            - Any instruction about what they should do
            - Any statement about what would help them
            
            Make each explanation personal and specific to the situation. Consider both immediate and underlying needs.`;
            
            try {
                // Make the API request
                const response = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer ${process.env.OPENAI_API_KEY}",                         
                    },
                    body: JSON.stringify({
                        model: "gpt-3.5-turbo",
                        messages: [
                            {
                                role: "user",
                                content: needsPrompt
                            }
                        ],
                        ...API_SETTINGS.needs
                    })
                });
                
                // Handle the response
                const data = await response.json();
                
                if (data.error) {
                    console.error("OpenAI API Error:", data.error);
                    secondOutputDiv.innerHTML = "Error: " + data.error.message;
                    return;
                }
                
                // Display the second response
                const aiResponse = data.choices[0].message.content.trim();
                
                // Convert markdown bold to HTML before displaying
                const formattedResponse = aiResponse.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                displayWithCheckboxes(formattedResponse, "secondOutput", "needs-group", "Your Needs");
                
                // Show the needs feedback section AND the missed needs option
                show("needsFeedbackSection");
                showParentMissedNeedsOption(); // Add this line
                
                scrollToElement("secondOutput");
                
            } catch (error) {
                console.error("Fetch Error:", error);
                secondOutputDiv.innerHTML = "Error: Network issue or invalid API key. Please check your console for details.";
            } finally {
                enableButton(button);
            }
        }
        
        // Function to move to Step 2
        function moveToStep2() {
            updateStepIndicator(2);
            hide("userInput");
            document.querySelector("button[onclick='analyzeText()']").style.display = "none";
            
            // Show Step 2
            show("step2Container");
            
            // Scroll to Step 2
            document.getElementById("step2Container").scrollIntoView({ behavior: "smooth" });
        }
        
        // Function to analyze child's feelings
        async function analyzeChildFeelings() {
            // Get all the input values
            const initialDescription = document.getElementById("userInput").value.trim();
            const childAction = document.getElementById("childAction").value.trim();
            const childWords = document.getElementById("childWords").value.trim();
            const recentChanges = document.getElementById("recentChanges").value.trim();
            const connectionTime = document.getElementById("connectionTime").value.trim();
            const neurodivergence = document.getElementById("neurodivergence").value.trim();

        
            
            const childFeelingsOutput = document.getElementById("childFeelingsOutput");
            
            // Remove any existing missed feelings sections
            const existingMissedFeelingsSection = document.getElementById("missedFeelingsSection");
            if (existingMissedFeelingsSection) {
                existingMissedFeelingsSection.remove();
            }
            
            // Validate that we have at least some information
            if (!childAction && !childWords && !recentChanges && !connectionTime && !neurodivergence) {
                childFeelingsOutput.innerHTML = "Please provide some information about your child to help with the analysis.";
                show("childFeelingsOutput");
                return;
            }
            
            // Show loading message
            childFeelingsOutput.innerHTML = "Analyzing your child's feelings... Please wait.";
            show("childFeelingsOutput");
            
            // Prepare the prompt that includes both step 1 and step 2 information
            // Full prompt for analyzeChildFeelings function
            const prompt = `You are Jen Lumanlan. You are working with a parent who is having trouble with their child's behavior. 
            The parent initially described the situation as: "${initialDescription}"

            Additional information about the child:
            - What the child did: "${childAction}"
            - What the child said: "${childWords}"
            - Recent changes in the child's life: "${recentChanges}"
            - Daily connection time: "${connectionTime}"
            - Neurodivergence: "${neurodivergence}"

            Based on ALL of this information, provide your hypothesis about what the child might be feeling.

            IMPORTANT INTERPRETATION GUIDELINES:
            1. When a child says "I'm not tired" at bedtime:
               - This PRIMARILY indicates BORED - they likely have energy and desire for more stimulation
               - Consider this first and foremost before other explanations
               - Children are usually honest about their energy levels - if they say they're not tired, they probably aren't

            2. Consider the physical and emotional context:
               - Time of day and usual schedule
               - Recent activity levels
               - Changes in routine
               - Connection needs
               - The child's actual perspective, not just what adults need

            Your response MUST:
            1. Start with "I wonder if your child might be feeling:"

            2. Format each feeling as a separate bullet point with "•" followed by <strong> tags around the feeling name.
            Format exactly like this:
            • <strong>LONELY</strong>: Your child is crying and saying "Mama," which indicates feelings of loneliness
            • <strong>SAD</strong>: The fact that your child is crying suggests sadness they cannot fully express
            • <strong>ANXIOUS</strong>: Their behavior indicates they might be feeling uncertain or worried
            
            3. ONLY use feelings from this exact list (and capitalize them): AFRAID, ANGRY, ANNOYED, ANXIOUS, ASHAMED, CONCERNED, CONFUSED, 
            DISAPPOINTED, DISCOURAGED, DISGUSTED, DISTANT, EMBARRASSED, ENVIOUS, EXCITED, FRUSTRATED, GRATEFUL, HAPPY, 
            HOPEFUL, HURT, IMPATIENT, INSECURE, IRRITATED, JEALOUS, JOYFUL, LONELY, NERVOUS, OVERWHELMED, PROUD, 
            RESENTFUL, SAD, SCARED, STRESSED, SURPRISED, TIRED, UNCOMFORTABLE, UNHAPPY, UPSET, WORRIED, BORED.
            
            Do not use any feelings that are not on this list, and especially avoid words that suggest blame 
            or judgment like "rejected," "unsupported," "abandoned," etc.
            
            IMPORTANT: Only consider information that the CHILD would actually know or be aware of.
            Pay special attention to:
            - CONNECTION TIME - lack of connection time with parents is a primary driver of children's behavior
            - AUTONOMY needs
            - LIFE CHANGES mentioned
            - NEURODIVERGENCE considerations
            
            NO ADVICE: Do NOT include any suggestions or advice on what the parent should do. Focus ONLY on identifying what the child might be feeling.
            DO NOT suggest actions for the parent to take or mention solutions to the behavior.
            DO NOT use phrases like "you may want to" or "consider" or any language that hints at actions the parent should take.
            DO NOT try to explain the purpose behind identifying feelings or how it will help - just identify the feelings.`;
            
            try {
                // Make the API request
                const response = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer ${process.env.OPENAI_API_KEY}",                         
                    },
                    body: JSON.stringify({
                        model: "gpt-3.5-turbo",
                        messages: [
                            {
                                role: "user",
                                content: prompt
                            }
                        ],
                        ...API_SETTINGS.feelings
                    })
                });
                
                // Handle the response
                const data = await response.json();
                
                if (data.error) {
                    console.error("OpenAI API Error:", data.error);
                    childFeelingsOutput.innerHTML = "Error: " + data.error.message;
                    return;
                }
                
                // Store and display the response
                childFeelingsResponse = data.choices[0].message.content.trim();
                displayWithCheckboxes(childFeelingsResponse, "childFeelingsOutput", "child-feelings-group", "Child's Feelings");
                
                // Show the feedback section
                show("childFeedbackSection");
                showMissedFeelingsOption();
                scrollToElement("childFeelingsOutput");
                
            } catch (error) {
                console.error("Fetch Error:", error);
                childFeelingsOutput.innerHTML = "Error: Network issue or invalid API key. Please check your console for details.";
            }
        }
        
        // Function to handle when child feelings are confirmed
        function childFeelingsConfirmed() {
            // Show child needs analysis section
            analyzeChildNeeds();
        }
        function addMissedFeelingsSection() {
          const childFeedbackSection = document.getElementById("childFeedbackSection");
                
          // Create the missed feelings section
          const missedFeelingsSection = document.createElement('div');
          missedFeelingsSection.id = 'missedFeelingsSection';
          missedFeelingsSection.style.marginTop = '15px';
          missedFeelingsSection.classList.add('hidden');
                
          // Add content to the section
          missedFeelingsSection.innerHTML = `
            <p>If you think ENSA might have missed a feeling, consider checking the 
              <a href="https://www.yourparentingmojo.com/feelings" target="_blank" rel="noopener noreferrer">feelings list</a> 
              and adding any you think are relevant here:</p>
            <textarea id="missedFeelings" rows="2" placeholder="Enter additional feelings (e.g., BORED, TIRED)..."></textarea><br>
            <button onclick="includeMissedFeelings()">Include these feelings in the analysis</button>
          `;
            
          // Insert it after the childFeedbackSection
          if (childFeedbackSection && childFeedbackSection.parentNode) {
            childFeedbackSection.parentNode.insertBefore(missedFeelingsSection, childFeedbackSection.nextSibling);
          }
        }
        function showMissedFeelingsOption() {
          addMissedFeelingsSection();
          show("missedFeelingsSection");
          scrollToElement("missedFeelingsSection");
        }
        
        // Function to handle including missed feelings
        function includeMissedFeelings() {
          const missedFeelingsText = document.getElementById("missedFeelings").value.trim();
        
          if (!missedFeelingsText) {
            alert("Please enter at least one feeling to include.");
            return;
          }
      
          // Save the current checkbox states before modifying the DOM
          const previouslyChecked = getCheckedItems("child-feelings-group");

          // Create bullet points for each feeling
          const additionalFeelings = missedFeelingsText
            .split(/[,\n]/)
            .map(feeling => feeling.trim())
            .filter(feeling => feeling)
            .map(feeling => {
              const uppercasedFeeling = feeling.toUpperCase();
              return `• <strong>${uppercasedFeeling}</strong>: This feeling was manually added because it seemed relevant`;
            })
            .join('\n');

          // Get current content but preserve the field's structure and selections
          const childFeelingsOutput = document.getElementById("childFeelingsOutput");
        
          // Update the childFeelingsResponse for next steps
          if (childFeelingsResponse) {
            childFeelingsResponse = childFeelingsResponse + '\n\nAdditional feelings:\n' + additionalFeelings;
          }

          // Create a separate container for the additional feelings
          const additionalFeelingsDiv = document.createElement('div');
          additionalFeelingsDiv.className = 'manually-added-feelings';
          additionalFeelingsDiv.innerHTML = `<p><em>Manually added feelings:</em></p>`;

          // Process each additional feeling into checkbox items
          missedFeelingsText
            .split(/[,\n]/)
            .map(feeling => feeling.trim())
            .filter(feeling => feeling)
            .forEach((feeling, index) => {
              const uppercasedFeeling = feeling.toUpperCase();
            
              const div = document.createElement('div');
              div.className = 'checkbox-item';
            
              const checkbox = document.createElement('input');
              checkbox.type = 'checkbox';
              checkbox.id = `child-feelings-group-additional-${index}`;
              checkbox.checked = true; // Default to checked for manually added feelings
            
              const labelElement = document.createElement('label');
              labelElement.htmlFor = checkbox.id;
              labelElement.innerHTML = `<strong>${uppercasedFeeling}</strong>: This feeling was manually added because it seemed relevant`;
            
              div.appendChild(checkbox);
              div.appendChild(labelElement);
              additionalFeelingsDiv.appendChild(div);
            });
        
          // Append the new feelings to the existing container
          childFeelingsOutput.appendChild(additionalFeelingsDiv);
        
          // Notify user
          alert("Additional feelings have been included! You can now proceed to confirm the feelings.");
        
          // Hide the missed feelings section since it's been used
          hide("missedFeelingsSection");
        
          // Re-display the feedback section to allow proceeding
          show("childFeedbackSection");
          scrollToElement("childFeedbackSection");
        }

        // Function to analyze child's needs
        async function analyzeChildNeeds() {
            // Get all the input values
            const initialDescription = document.getElementById("userInput").value.trim();
            const childAction = document.getElementById("childAction").value.trim();
            const childWords = document.getElementById("childWords").value.trim();
            const recentChanges = document.getElementById("recentChanges").value.trim();
            const connectionTime = document.getElementById("connectionTime").value.trim();
            const neurodivergence = document.getElementById("neurodivergence").value.trim();

            const currentScroll = window.scrollY;
            window.scrollTo(window.scrollX, currentScroll);

            // Remove any existing missed needs sections
            const existingMissedNeedsSection = document.getElementById("missedNeedsSection");
            if (existingMissedNeedsSection) {
                existingMissedNeedsSection.remove();
            }
            
            // Get selected child feelings
            const selectedChildFeelings = getSelectedItems("child-feelings-group").join(", ");
            
            const childNeedsOutput = document.getElementById("childNeedsOutput");
            
            // Show loading message
            childNeedsOutput.innerHTML = "Analyzing your child's needs... Please wait.";
            show("childNeedsOutput");
            
            // Prepare the prompt that includes all information
            // Update the prompt in the analyzeChildNeeds and reAnalyzeChildNeeds functions
            const prompt = `You are Jen Lumanlan. You are working with a parent who is having trouble with their child's behavior. 
            The parent initially described the situation as: "${initialDescription}"

            Additional information:
            - What the child did: "${childAction}"
            - What the child said: "${childWords}"
            - Recent changes: "${recentChanges}"
            - Daily connection time: "${connectionTime}"
            - Neurodivergence: "${neurodivergence}"

            Based on ALL of this information and considering that your child might be feeling: ${selectedChildFeelings}

            Your response MUST:
            1. Start with "I wonder if your child might have needs for:"

            2. Format each need as a separate bullet point with "•" followed by <strong> tags around the need name.
            Format exactly like this:
            • <strong>CONNECTION</strong>: Their behavior shows they're seeking more one-on-one time with you
            • <strong>PLAY</strong>: When they say "I'm not tired," they're expressing their current energy levels
            
            3. ONLY use needs from these categories (and capitalize them):
            CONNECTION: ACCEPTANCE, APPRECIATION, BELONGING, COLLABORATION, COMMUNICATION, EMPATHY, KINDNESS, LOVE, PARTNERSHIP, SUPPORT, TO UNDERSTAND AND BE UNDERSTOOD, TOUCH, TRUST
            
            PEACE: BEAUTY, CALM, EASE, HARMONY, ORDER, RESPECT
            
            HONESTY: AUTHENTICITY, INTEGRITY, PRESENCE
            
            MEANING: CHALLENGE, COMPETENCE, CREATIVITY, GROWTH, HAVING A SENSE OF PURPOSE, HOPE, LEARNING, SELF-CONNECTION, SELF-EXPRESSION
            
            SAFETY: CONSISTENCY, PHYSICAL AND EMOTIONAL SAFETY
            
            AUTONOMY: CHOICE, FREEDOM, INDEPENDENCE, POWER, SPACE/FREEDOM FROM TOUCH
            
            RELAXATION: EXCITEMENT, FUN, HUMOR, INDULGENCE, JOY, MENTAL SPACE, PLAY, PLEASURE
            
            PHYSICAL WELL-BEING: AIR, COMFORT, EXERCISE, FOOD/WATER, REST/SLEEP, SAFETY, SELF-CARE
            
            IMPORTANT WORD CHOICE GUIDELINES:
            - State needs directly as observations: "They're seeking..." not "They need..."
            - DO NOT use "could help them" phrases
            - DO NOT mention benefits of meeting needs
            - DO NOT introduce other needs in descriptions (keep each need separate)
            - Avoid phrases like "would benefit from" or "this would give them"
            - Focus on describing what the need IS, not what meeting it would DO
            
            FORBIDDEN PHRASES - NEVER USE:
            - "could help them feel..."
            - "this would provide them..."
            - "this would give them..."
            - "this will help them..."
            - "would benefit from..."
            - "allowing them to..."
            - "enabling them to..."
            - Any framing that suggests meeting one need leads to another outcome
            
            ADDITIONAL GUIDELINES:
            - Treat behaviors as SOLUTIONS children find to meet their needs, not as problems
            - Focus on what the child is actively DOING to meet their needs
            - Avoid contradicting yourself between different needs explanations
            - Keep explanations grounded in the actual information provided
            - Consider the timing and context of behaviors (e.g., bedtime, transitions)
            
            Be specific about how each need relates to the situation described, without suggesting that meeting the need will "fix" anything.`;
            
            try {
                // Make the API request
                const response = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer ${process.env.OPENAI_API_KEY}",                         
                    },
                    body: JSON.stringify({
                        model: "gpt-3.5-turbo",
                        messages: [
                            {
                                role: "user",
                                content: prompt
                            }
                        ],
                        ...API_SETTINGS.needs
                    })
                });
                
                // Handle the response
                const data = await response.json();
                
                if (data.error) {
                    console.error("OpenAI API Error:", data.error);
                    childNeedsOutput.innerHTML = "Error: " + data.error.message;
                    return;
                }
                
                // Display the response
                const aiResponse = data.choices[0].message.content.trim();
                displayWithCheckboxes(aiResponse, "childNeedsOutput", "child-needs-group", "Child's Needs");
                
                // Show the feedback section
                show("childNeedsFeedbackSection");

                showMissedNeedsOption(); 
                scrollToElement("childNeedsOutput");
                
            } catch (error) {
                console.error("Fetch Error:", error);
                childNeedsOutput.innerHTML = "Error: Network issue or invalid API key. Please check your console for details.";
            }
        }
        function addMissedNeedsSection() {
          const childNeedsFeedbackSection = document.getElementById("childNeedsFeedbackSection");

          // Create the missed needs section
          const missedNeedsSection = document.createElement('div');
          missedNeedsSection.id = 'missedNeedsSection';
          missedNeedsSection.style.marginTop = '15px';
          missedNeedsSection.classList.add('hidden');

          // Add content to the section
          missedNeedsSection.innerHTML = `
            <p>If you think ENSA might have missed a need, consider checking the 
              <a href="https://www.yourparentingmojo.com/needs" target="_blank" rel="noopener noreferrer">needs list</a> 
              and adding any you think are relevant here:</p>
            <textarea id="missedNeeds" rows="2" placeholder="Enter additional needs (e.g., PLAY, INDEPENDENCE)..."></textarea><br>
            <button onclick="includeMissedNeeds()">Include these needs in the analysis</button>
          `;
            
          // Insert it after the childNeedsFeedbackSection
          if (childNeedsFeedbackSection && childNeedsFeedbackSection.parentNode) {
            childNeedsFeedbackSection.parentNode.insertBefore(missedNeedsSection, childNeedsFeedbackSection.nextSibling);
          }
        }

        // Function to display the missed needs option
        function showMissedNeedsOption() {
          addMissedNeedsSection();
          show("missedNeedsSection");
          scrollToElement("missedNeedsSection");
        }

        // Function to include missed needs
        function includeMissedNeeds() {
          const missedNeedsText = document.getElementById("missedNeeds").value.trim();
        
          if (!missedNeedsText) {
            alert("Please enter at least one need to include.");
            return;
          }
      
          // Save the current checkbox states before modifying the DOM
          const previouslyChecked = getCheckedItems("child-needs-group");

          // Create a separate container for the additional needs
          const additionalNeedsDiv = document.createElement('div');
          additionalNeedsDiv.className = 'manually-added-needs';
          additionalNeedsDiv.innerHTML = `<p><em>Manually added needs:</em></p>`;

          // Process each additional need into checkbox items
          missedNeedsText
            .split(/[,\n]/)
            .map(need => need.trim())
            .filter(need => need)
            .forEach((need, index) => {
              const uppercasedNeed = need.toUpperCase();
            
              const div = document.createElement('div');
              div.className = 'checkbox-item';
            
              const checkbox = document.createElement('input');
              checkbox.type = 'checkbox';
              checkbox.id = `child-needs-group-additional-${index}`;
              checkbox.checked = true; // Default to checked for manually added needs
            
              const labelElement = document.createElement('label');
              labelElement.htmlFor = checkbox.id;
              labelElement.innerHTML = `<strong>${uppercasedNeed}</strong>: This need was manually added because it seemed relevant`;
            
              div.appendChild(checkbox);
              div.appendChild(labelElement);
              additionalNeedsDiv.appendChild(div);
            });
        
          // Get the current needs output element and append the new needs (don't replace)
          const childNeedsOutput = document.getElementById("childNeedsOutput");
          childNeedsOutput.appendChild(additionalNeedsDiv);
        
          // Notify user
          alert("Additional needs have been included! You can now proceed to the strategies step.");
        
          // Hide the missed needs section since it's been used
          hide("missedNeedsSection");
        
          // Re-display the feedback section to allow proceeding
          show("childNeedsFeedbackSection");
          scrollToElement("childNeedsFeedbackSection");
        }

        // Function to re-analyze child's needs with updated information
        async function reAnalyzeChildNeeds() {
            // Get the current selected feelings
            const previouslyChecked = getCheckedItems("child-needs-group");
            const selectedChildFeelings = getSelectedItems("child-feelings-group").join(", ");
            const childNeedsOutput = document.getElementById("childNeedsOutput");
            
            // Remove any existing missed needs sections
            const existingMissedNeedsSection = document.getElementById("missedNeedsSection");
            if (existingMissedNeedsSection) {
                existingMissedNeedsSection.remove();
            }

            // Show loading message
            childNeedsOutput.innerHTML = "Re-analyzing your child's needs... Please wait.";

            // Get all updated input values
            const initialDescription = document.getElementById("userInput").value.trim();
            const childAction = document.getElementById("childAction").value.trim();
            const childWords = document.getElementById("childWords").value.trim();
            const recentChanges = document.getElementById("recentChanges").value.trim();
            const connectionTime = document.getElementById("connectionTime").value.trim();
            const neurodivergence = document.getElementById("neurodivergence").value.trim();

            // Create prompt with updated information
            // Update the prompt in the analyzeChildNeeds and reAnalyzeChildNeeds functions
            const prompt = `You are Jen Lumanlan. You are working with a parent who is having trouble with their child's behavior. 
                The parent initially described the situation as: "${initialDescription}"

                Additional information:
                - What the child did: "${childAction}"
                - What the child said: "${childWords}"
                - Recent changes: "${recentChanges}"
                - Daily connection time: "${connectionTime}"
                - Neurodivergence: "${neurodivergence}"

                Based on ALL of this information and considering that your child might be feeling: ${selectedChildFeelings}

                Your response MUST:
                1. Start with "I wonder if your child might have needs for:"

                2. Format each need as a separate bullet point with "•" followed by <strong> tags around the need name.
                Format exactly like this:
                • <strong>CONNECTION</strong>: Their behavior shows they're seeking more one-on-one time with you
                • <strong>PLAY</strong>: When they say "I'm not tired," they're expressing their current energy levels
                
                3. ONLY use needs from these categories (and capitalize them):
                CONNECTION: ACCEPTANCE, APPRECIATION, BELONGING, COLLABORATION, COMMUNICATION, EMPATHY, KINDNESS, LOVE, PARTNERSHIP, SUPPORT, TO UNDERSTAND AND BE UNDERSTOOD, TOUCH, TRUST
                
                PEACE: BEAUTY, CALM, EASE, HARMONY, ORDER, RESPECT
                
                HONESTY: AUTHENTICITY, INTEGRITY, PRESENCE
                
                MEANING: CHALLENGE, COMPETENCE, CREATIVITY, GROWTH, HAVING A SENSE OF PURPOSE, HOPE, LEARNING, SELF-CONNECTION, SELF-EXPRESSION
                
                SAFETY: CONSISTENCY, PHYSICAL AND EMOTIONAL SAFETY
                
                AUTONOMY: CHOICE, FREEDOM, INDEPENDENCE, POWER, SPACE/FREEDOM FROM TOUCH
                
                RELAXATION: EXCITEMENT, FUN, HUMOR, INDULGENCE, JOY, MENTAL SPACE, PLAY, PLEASURE
                
                PHYSICAL WELL-BEING: AIR, COMFORT, EXERCISE, FOOD/WATER, REST/SLEEP, SAFETY, SELF-CARE
                
                IMPORTANT WORD CHOICE GUIDELINES:
                - State needs directly as observations: "They're seeking..." not "They need..."
                - DO NOT use "could help them" phrases
                - DO NOT mention benefits of meeting needs
                - DO NOT introduce other needs in descriptions (keep each need separate)
                - Avoid phrases like "would benefit from" or "this would give them"
                - Focus on describing what the need IS, not what meeting it would DO
                
                FORBIDDEN PHRASES - NEVER USE:
                - "could help them feel..."
                - "this would provide them..."
                - "this would give them..."
                - "this will help them..."
                - "would benefit from..."
                - "allowing them to..."
                - "enabling them to..."
                - Any framing that suggests meeting one need leads to another outcome
                
                ADDITIONAL GUIDELINES:
                - Treat behaviors as SOLUTIONS children find to meet their needs, not as problems
                - Focus on what the child is actively DOING to meet their needs
                - Avoid contradicting yourself between different needs explanations
                - Keep explanations grounded in the actual information provided
                - Consider the timing and context of behaviors (e.g., bedtime, transitions)
                
                Be specific about how each need relates to the situation described, without suggesting that meeting the need will "fix" anything.`;

                try {
                // Make the API request
                const response = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer ${process.env.OPENAI_API_KEY}",                         
                    },
                    body: JSON.stringify({
                        model: "gpt-3.5-turbo",
                        messages: [{ role: "user", content: prompt }],
                        ...API_SETTINGS.needs
                    })
                });
            
                const data = await response.json();
                if (data.error) {
                    throw new Error(data.error.message);
                }
            
                // Display the updated needs analysis
                const aiResponse = data.choices[0].message.content.trim();
                displayWithCheckboxes(aiResponse, "childNeedsOutput", "child-needs-group", "Child's Needs", previouslyChecked);
                show("childNeedsFeedbackSection");
                scrollToElement("childNeedsFeedbackSection");
            
            } catch (error) {
                console.error("Error:", error);
                childNeedsOutput.innerHTML = "Error: " + error.message;
            }
        }

        // Function to move to Step 3
        function moveToStep3() {
            updateStepIndicator(3);
            // Show Step 3
            show("step3Container");
            
            // Start analyzing strategies
            analyzeStrategies();
            
            // Scroll to Step 3
            document.getElementById("step3Container").scrollIntoView({ behavior: "smooth" });

        }
        function displayStrategiesFeedback() {
            const feedbackSection = document.getElementById("strategiesFeedbackSection");
            if (!feedbackSection) return;
            
            show("strategiesFeedbackSection");
            feedbackSection.innerHTML = `
                <p>You don't have to try all of these ideas! They're intended to give you a starting point for what might work for both of you.</p>
                <p>Do you see something here you could try? If not, please explain below and I'll give you some more ideas.</p>
                <p><strong>Uncheck any options you don't think will be helpful</strong>, and then I'll give you more detail on how to implement the ideas you'd like to try.</p>
                <textarea id="strategyFeedback" rows="4" placeholder="Let me know what won't work about these strategies and why..."></textarea>
                <p class="strategy-note" style="font-style: italic; color: #666; margin-top: 8px; font-size: 0.9em;">The ENSA tool can have a hard time thinking creatively about strategies. If the needs seem right but the strategies aren't good, share your needs with us in the community and we'll help you find strategies!</p>
                <div class="button-container" style="margin-top:15px;">
                    <button onclick="getImplementationDetails()">Get Implementation Details</button>
                    <button onclick="reAnalyzeStrategies()">Re-Analyze Strategies</button>
                </div>
            `;
            
            scrollToElement("strategiesFeedbackSection");
        }

        // Function to analyze strategies
        async function analyzeStrategies(feedbackText = "") {
            // Get all relevant data from previous steps
            const initialDescription = document.getElementById("userInput").value.trim();
            const childAction = document.getElementById("childAction").value.trim();
            const childWords = document.getElementById("childWords").value.trim();
            const recentChanges = document.getElementById("recentChanges").value.trim();
            const connectionTime = document.getElementById("connectionTime").value.trim();
            const neurodivergence = document.getElementById("neurodivergence").value.trim();
            
            const strategiesOutput = document.getElementById("strategiesOutput");
            
            // Show loading message
            show("strategiesOutput");
            strategiesOutput.innerHTML = "Analyzing possible strategies... Please wait.";
            
            // Create a prompt that includes all information from previous steps plus any feedback
            const prompt = `You are Jen Lumanlan, creator of Your Parenting Mojo. You work with a relationship-based framework that NEVER uses rewards, consequences, or compliance-based approaches.
            
            Parent's description: "${initialDescription}"
            Child information:
            - Actions: "${childAction}"
            - Words: "${childWords}"
            - Recent changes: "${recentChanges}"
            - Daily connection time: "${connectionTime}"
            - Neurodivergence: "${neurodivergence}"
                    
            Parent's feelings: ${firstPromptResponse}
            Child's feelings: ${childFeelingsResponse}
            ${feedbackText ? "Parent's feedback: " + feedbackText : ""}
                    
            Your response MUST:
            1. Start with "Here are some strategies that might help both you and your child:"
            2. List 3-4 specific, practical strategies
            3. Format each strategy as:
            • <strong>Strategy name</strong>: Brief description
              - How it helps you: [specific benefit]
              - How it helps the child: [specific benefit]
            
            IMPORTANT FORMATTING INSTRUCTIONS:
            - Use HTML <strong> tags for emphasis, NOT markdown asterisks
            - NEVER use ** around strategy names - use <strong> and </strong> instead
            - Format exactly as shown in the example below
                    
            FORBIDDEN APPROACHES - NEVER SUGGEST:
            - Rewards or "reinforcement"
            - Punishment or consequences
            - Sticker charts or token systems
            - Time-outs or separation
            - Compliance-based strategies
            - Visual schedules for compliance
            - Bribes or incentives
            - "Setting expectations"
                    
            REQUIRED PRINCIPLES:
            - Meet BOTH parent and child needs simultaneously
            - Change the environment, not the child
            - Create solutions that don't require compliance
            - Focus on prevention over management
            - Suggest structural changes where possible
            - Keep connection genuine, never as leverage
                    
            Example format:
            • <strong>Adjust morning timing</strong>: Wake up 15 minutes earlier to allow for natural transitions
              - How it helps you: Reduces time pressure and stress
              - How it helps the child: Can move at their own pace
        
            Make each strategy specific to this situation while avoiding ANY form of control or compliance-based approaches.`;
            
            try {
                // Make the API request
                const response = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer ${process.env.OPENAI_API_KEY}",                         
                    },
                    body: JSON.stringify({
                        model: "gpt-3.5-turbo",
                        messages: [
                            {
                                role: "user",
                                content: prompt
                            }
                        ],
                        ...API_SETTINGS.strategies
                    })
                });
                
                // Handle the response
                const data = await response.json();
                
                if (data.error) {
                    console.error("OpenAI API Error:", data.error);
                    strategiesOutput.innerHTML = "Error: " + data.error.message;
                    return;
                }
                
                // Display the response
                const aiResponse = data.choices[0].message.content.trim();
                strategiesOutput.innerHTML = aiResponse;
                
                displayWithCheckboxes(aiResponse, "strategiesOutput", "strategies-group", "Possible Strategies");
    
                // Show the feedback section with updated text
                await displayStrategiesFeedback();
                scrollToElement("strategiesOutput");
                
            } catch (error) {
                console.error("Fetch Error:", error);
                strategiesOutput.innerHTML = "Error: Network issue or invalid API key. Please check your console for details.";
            }
        }
        
        // Function to re-analyze strategies with feedback
        function reAnalyzeStrategies() {
            const feedbackText = document.getElementById("strategyFeedback").value.trim();
            if (feedbackText) {
                analyzeStrategies(feedbackText);
            } else {
                alert("Please provide some feedback about why the strategies won't work so we can give you better alternatives.");
            }
        }

        // Function to get implementation details for selected strategies

        async function getImplementationDetails() {
            const selectedStrategies = getSelectedItems("strategies-group");
            if (selectedStrategies.length === 0) {
                alert("Please select at least one strategy to get implementation details.");
                return;
            }
        
            // Disable button while processing to prevent multiple clicks
            const button = document.querySelector('button[onclick="getImplementationDetails()"]');
            if (button) button.disabled = true;
        
            let detailsOutput = document.getElementById("implementationDetails");
            if (!detailsOutput) {
                detailsOutput = document.createElement('div');
                detailsOutput.id = 'implementationDetails';
                detailsOutput.className = 'child-feelings-container output-container'; // Add output-container class

                // Ensure proper positioning in the DOM
                const strategiesFeedbackSection = document.getElementById("strategiesFeedbackSection");
                if (strategiesFeedbackSection && strategiesFeedbackSection.parentNode) {
                    strategiesFeedbackSection.parentNode.insertBefore(detailsOutput, strategiesFeedbackSection.nextSibling);
                } else {
                    // Fallback if feedback section isn't found
                    const step3Container = document.getElementById("step3Container");
                    if (step3Container) {
                        step3Container.appendChild(detailsOutput);
                    }
                }
            }
        
            // Make sure it's visible
            detailsOutput.style.display = "block";
            detailsOutput.innerHTML = "<p>Generating implementation details... Please wait.</p>";

            // Add clear styles to make it stand out
            detailsOutput.style.marginTop = "20px";
            detailsOutput.style.marginBottom = "20px";
            detailsOutput.style.padding = "15px";

            // Scroll to make sure it's visible
            scrollToElement("implementationDetails");
        
            const prompt = `You are Jen Lumanlan. Based on these selected strategies: ${selectedStrategies.join(", ")}

            Please provide detailed implementation guidance. Your response MUST:
            1. Start with "Here are some ideas for how these strategies could work. Feel free to modify them to suit you and your child!"
            2. For each strategy:
               • Start with the strategy name in <strong> tags
               • Explain the implementation in a before-during-after format
               • Be specific and practical
               • Keep focus on connection and meeting both parent and child needs
            
            Remember:
            - No compliance-based approaches
            - Focus on prevention and connection
            - Keep suggestions flexible and adaptable
            - Maintain respect for both parent and child needs`;
            
            try {
                const response = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer ${process.env.OPENAI_API_KEY}",                         
                    },
                    body: JSON.stringify({
                        model: "gpt-3.5-turbo",
                        messages: [{ role: "user", content: prompt }],
                        ...API_SETTINGS.strategies
                    })
                });
            
                const data = await response.json();
                if (data.error) throw new Error(data.error.message);
            
                detailsOutput.innerHTML = data.choices[0].message.content.trim();

                // Add heading for clarity
                const heading = document.createElement('h3');
                heading.textContent = "Implementation Details";
                heading.style.marginTop = "0";
                heading.style.marginBottom = "1rem";
                heading.style.color = "var(--primary-color)";
                detailsOutput.insertBefore(heading, detailsOutput.firstChild);

                scrollToElement("implementationDetails");
            
            } catch (error) {
                console.error("Error:", error);
                detailsOutput.innerHTML = "Error: " + error.message;
            } finally {
                // Re-enable button
                if (button) button.disabled = false;
            }
        }
        function updateStepIndicator(currentStep) {
            const progressBars = document.querySelectorAll('.step-indicator, .step-indicator-clone');

            progressBars.forEach(bar => {
                const steps = bar.querySelectorAll('.step');
                const totalSteps = steps.length;
                const progress = bar.querySelector('.step-line-progress');

                steps.forEach((step, index) => {
                    if (index + 1 < currentStep) {
                        step.classList.add('completed');
                        step.classList.remove('active');
                    } else if (index + 1 === currentStep) {
                        step.classList.add('active');
                        step.classList.remove('completed');
                    } else {
                        step.classList.remove('active', 'completed');
                    }
                });

                // Calculate progress width based on number of steps
                // This ensures the progress bar stays within the step indicators
                const progressWidth = ((currentStep - 1) / (totalSteps - 1)) * 100;
                progress.style.width = `${Math.min(progressWidth, 100)}%`; // Ensure it never exceeds 100%
            });
        }
        document.addEventListener('DOMContentLoaded', () => {
            updateStepIndicator(1);
        });

        // Function to add the missed feelings section for parent feelings
        function addParentMissedFeelingsSection() {
          const feedbackSection = document.getElementById("feedbackSection");
          
          // Create the missed feelings section
          const missedFeelingsSection = document.createElement('div');
          missedFeelingsSection.id = 'parentMissedFeelingsSection';
          missedFeelingsSection.style.marginTop = '15px';
          missedFeelingsSection.classList.add('hidden');
          
          // Add content to the section
          missedFeelingsSection.innerHTML = `
            <p>If you think ENSA might have missed a feeling, consider checking the 
              <a href="https://www.yourparentingmojo.com/feelings" target="_blank" rel="noopener noreferrer">feelings list</a> 
              and adding any you think are relevant here:</p>
            <textarea id="parentMissedFeelings" rows="2" placeholder="Enter additional feelings (e.g., EXHAUSTED, WORRIED)..."></textarea><br>
            <button onclick="includeParentMissedFeelings()">Include these feelings in the analysis</button>
          `;
          
          // Insert it after the feedbackSection
          if (feedbackSection && feedbackSection.parentNode) {
            feedbackSection.parentNode.insertBefore(missedFeelingsSection, feedbackSection.nextSibling);
          }
        }

        // Function to display the missed feelings option for parent
        function showParentMissedFeelingsOption() {
          addParentMissedFeelingsSection();
          show("parentMissedFeelingsSection");
          scrollToElement("parentMissedFeelingsSection");
        }

        // Function to handle including parent's missed feelings
        function includeParentMissedFeelings() {
          const missedFeelingsText = document.getElementById("parentMissedFeelings").value.trim();

          if (!missedFeelingsText) {
            alert("Please enter at least one feeling to include.");
            return;
          }

          // Save the current checkbox states before modifying the DOM
          const previouslyChecked = getCheckedItems("feelings-group");
          
          // Get current content but preserve the field's structure and selections
          const feelingsOutput = document.getElementById("output");
          
          // Update the firstPromptResponse for next steps
          if (firstPromptResponse) {
            firstPromptResponse = firstPromptResponse + '\n\nAdditional feelings:\n' + missedFeelingsText
              .split(/[,\n]/)
              .map(feeling => feeling.trim())
              .filter(feeling => feeling)
              .map(feeling => {
                const uppercasedFeeling = feeling.toUpperCase();
                return `• <strong>${uppercasedFeeling}</strong>: This feeling was manually added because it seemed relevant`;
              })
              .join('\n');
          }

          // Create a separate container for the additional feelings
          const additionalFeelingsDiv = document.createElement('div');
          additionalFeelingsDiv.className = 'manually-added-feelings';
          additionalFeelingsDiv.innerHTML = `<p><em>Manually added feelings:</em></p>`;

          // Process each additional feeling into checkbox items
          missedFeelingsText
            .split(/[,\n]/)
            .map(feeling => feeling.trim())
            .filter(feeling => feeling)
            .forEach((feeling, index) => {
              const uppercasedFeeling = feeling.toUpperCase();
              
              const div = document.createElement('div');
              div.className = 'checkbox-item';
              
              const checkbox = document.createElement('input');
              checkbox.type = 'checkbox';
              checkbox.id = `feelings-group-additional-${index}`;
              checkbox.checked = true; // Default to checked for manually added feelings
              
              const labelElement = document.createElement('label');
              labelElement.htmlFor = checkbox.id;
              labelElement.innerHTML = `<strong>${uppercasedFeeling}</strong>: This feeling was manually added because it seemed relevant`;
              
              div.appendChild(checkbox);
              div.appendChild(labelElement);
              additionalFeelingsDiv.appendChild(div);
            });

          // Append the new feelings to the existing container
          feelingsOutput.appendChild(additionalFeelingsDiv);

          // Notify user
          alert("Additional feelings have been included! You can now proceed to confirm the feelings.");

          // Hide the missed feelings section since it's been used
          hide("parentMissedFeelingsSection");

          // Re-display the feedback section to allow proceeding
          show("feedbackSection");
          scrollToElement("feedbackSection");
        }

        // Function to add the missed needs section for parent needs
        function addParentMissedNeedsSection() {
          const needsFeedbackSection = document.getElementById("needsFeedbackSection");
          
          // Create the missed needs section
          const missedNeedsSection = document.createElement('div');
          missedNeedsSection.id = 'parentMissedNeedsSection';
          missedNeedsSection.style.marginTop = '15px';
          missedNeedsSection.classList.add('hidden');
          
          // Add content to the section
          missedNeedsSection.innerHTML = `
            <p>If you think ENSA might have missed a need, consider checking the 
              <a href="https://www.yourparentingmojo.com/needs" target="_blank" rel="noopener noreferrer">needs list</a> 
              and adding any you think are relevant here:</p>
            <textarea id="parentMissedNeeds" rows="2" placeholder="Enter additional needs (e.g., REST, CONSISTENCY)..."></textarea><br>
            <button onclick="includeParentMissedNeeds()">Include these needs in the analysis</button>
          `;
          
          // Insert it after the needsFeedbackSection
          if (needsFeedbackSection && needsFeedbackSection.parentNode) {
            needsFeedbackSection.parentNode.insertBefore(missedNeedsSection, needsFeedbackSection.nextSibling);
          }
        }

        // Function to display the missed needs option for parent
        function showParentMissedNeedsOption() {
          addParentMissedNeedsSection();
          show("parentMissedNeedsSection");
          scrollToElement("parentMissedNeedsSection");
        }

        // Function to include parent's missed needs
        function includeParentMissedNeeds() {
          const missedNeedsText = document.getElementById("parentMissedNeeds").value.trim();

          if (!missedNeedsText) {
            alert("Please enter at least one need to include.");
            return;
          }

          // Save the current checkbox states before modifying the DOM
          const previouslyChecked = getCheckedItems("needs-group");

          // Create a separate container for the additional needs
          const additionalNeedsDiv = document.createElement('div');
          additionalNeedsDiv.className = 'manually-added-needs';
          additionalNeedsDiv.innerHTML = `<p><em>Manually added needs:</em></p>`;

          // Process each additional need into checkbox items
          missedNeedsText
            .split(/[,\n]/)
            .map(need => need.trim())
            .filter(need => need)
            .forEach((need, index) => {
              const uppercasedNeed = need.toUpperCase();
              
              const div = document.createElement('div');
              div.className = 'checkbox-item';
              
              const checkbox = document.createElement('input');
              checkbox.type = 'checkbox';
              checkbox.id = `needs-group-additional-${index}`;
              checkbox.checked = true; // Default to checked for manually added needs
              
              const labelElement = document.createElement('label');
              labelElement.htmlFor = checkbox.id;
              labelElement.innerHTML = `<strong>${uppercasedNeed}</strong>: This need was manually added because it seemed relevant`;
              
              div.appendChild(checkbox);
              div.appendChild(labelElement);
              additionalNeedsDiv.appendChild(div);
            });

          // Get the current needs output element and append the new needs (don't replace)
          const needsOutput = document.getElementById("secondOutput");
          needsOutput.appendChild(additionalNeedsDiv);

          // Notify user
          alert("Additional needs have been included! You can now proceed to the next step.");

          // Hide the missed needs section since it's been used
          hide("parentMissedNeedsSection");

          // Re-display the feedback section to allow proceeding
          show("needsFeedbackSection");
          scrollToElement("needsFeedbackSection");
        }
    </script>
</body>
</html>


